<div class="products-header">

    <div class="order-summary">
        <span>Cliente: <strong id="client-name">{{ form.cliente.data }}</strong></span><br>
        <span>Teléfono: <strong id="client-phone">{{ form.telefono.data }}</strong></span>
    </div>
</div>
<div class="container text-center">
    <div class="row">
        <div class="col">
            <h2>Agregar Productos</h2>
        </div>
    </div>
</div>
{% for producto in productos %}
<button type="button"
        class="btn btn-secondary m-1"
        onclick="agregarAlCarrito('{{ producto.id }}', '{{ producto.nombre }}', '{{ producto.precio }}')"
        >{{ producto.nombre }}
</button>
{% endfor %}

<div class="order-items">
    <div id="productos-seleccionados" class="selected-products">
        <!-- Lista de productos seleccionados -->
    </div>

    <div id="acciones" style="margin-top:20px;">

    </div>

    <div class="order-total">
        <div>Subtotal: $<span id="subtotal">0</span></div>
        <div>Envío: $<span id="shipping">0</span></div>
        <div>Total: $<span id="total">0</span></div>
    </div>

    <div class="action-buttons">
        <button class="back-btn">Volver</button>
        <button class="payment-btn">Proceder al Pago</button>
    </div>
</div>

<script>
    // Función para agregar productos al carrito
    function agregarAlCarrito(id, nombre, precio) {
        // Verificar si el producto ya existe en el carrito
        if (window.carritoItems && window.carritoItems[id]) {
            // Si ya existe, incrementar su cantidad
            window.carritoItems[id].cantidad++;
            
            // Actualizar la cantidad mostrada
            const cantidadElement = document.getElementById(`cantidad-${id}`);
            if (cantidadElement) {
                cantidadElement.textContent = window.carritoItems[id].cantidad;
                
                // Actualizar precio
                const precioElement = document.getElementById(`precio-${id}`);
                if (precioElement) {
                    precioElement.textContent = `$${(window.carritoItems[id].precio * window.carritoItems[id].cantidad).toLocaleString()}`;
                }
                
                // Actualizar totales
                actualizarTotalesCarrito();
            }
        } else {
            // Si no existe, agregar usando HTMX
            htmx.ajax('POST', '/pruebas/agregar_producto', {
                target: '#productos-seleccionados',
                swap: 'beforeend',
                values: {
                    id: id,
                    nombre: nombre,
                    precio: precio
                }
            });
        }
    }
    
    // Función global para actualizar totales
    function actualizarTotalesCarrito() {
        if (!window.carritoItems) return;
        
        // Calcular subtotal
        let subtotal = 0;
        Object.values(window.carritoItems).forEach(item => {
            subtotal += item.precio * item.cantidad;
        });
        
        // Envío fijo por ahora
        const envio = Object.keys(window.carritoItems).length > 0 ? 1000 : 0;
        
        // Total
        const total = subtotal + envio;
        
        // Actualizar elementos en el DOM
        document.getElementById('subtotal').textContent = subtotal.toLocaleString();
        document.getElementById('shipping').textContent = envio.toLocaleString();
        document.getElementById('total').textContent = total.toLocaleString();
    }
</script>